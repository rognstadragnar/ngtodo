{"version":3,"sources":["../../src/wrappers/Wrapper.js"],"names":[],"mappings":"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","file":"Wrapper.js","sourcesContent":["import path from 'path';\nimport _ from 'lodash';\nimport webpack from 'webpack';\nimport packageJson from '../../package';\nimport options from '../options';\nimport hmr from '../hmr';\nimport hmrConfig from '../hmr/config';\nimport log from '../log';\nimport caches from '../caches';\nimport Watcher from './Watcher';\n\nclass Wrapper {\n  constructor(opts, config) {\n    this.opts = options(opts);\n\n    this.logger = log('wrapper', this.opts);\n\n    // TODO: remove this, in favour of `opts.config`\n    // Convenience hook to pass an object in. Mostly of convenience in the\n    // test suite\n    this.config = config;\n\n    // State\n    this.watcher = null;\n\n    // Callbacks\n    this._onceDone = [];\n  }\n  getConfig(cb) {\n    this.logger('fetching config object');\n\n    if (this.config) {\n      return cb(null, this.config);\n    }\n\n    if (!this.opts.config) {\n      return cb(new Error('Wrapper options missing `config` value'));\n    }\n\n    let factory;\n\n    if (_.isString(this.opts.config)) {\n      this.logger(`loading config file ${this.opts.config}`);\n      try {\n        factory = require(this.opts.config);\n      } catch(err) {\n        return cb(err);\n      }\n\n      if (!_.isFunction(factory)) {\n        return cb(new Error(`File ${this.opts.config} does not export a function`));\n      }\n    } else {\n      factory = this.opts.config;\n\n      if (!_.isFunction(factory)) {\n        return cb(new Error(`Config option is not a function`));\n      }\n    }\n\n    try {\n      this.config = factory(this.opts);\n    } catch(err) {\n      return cb(err);\n    }\n\n    if (!this.config || !_.isObject(this.config)) {\n      if (_.isString(this.opts.config)) {\n        return cb(new Error(`The factory exported by ${this.opts.config} did not return an object`));\n      }\n      return cb(new Error('The config factory does not return an object'));\n    }\n\n    if (this.opts.hmr) {\n      try {\n        hmrConfig(this.config, this.opts);\n      } catch(err) {\n        return cb(err);\n      }\n    }\n\n    if (this.opts.outputPath && this.config.output) {\n      this.config.output.path = this.opts.outputPath;\n    }\n\n    cb(null, this.config)\n  }\n  getCompiler(cb) {\n    this.logger('creating compiler');\n    this.getConfig((err, config) => {\n      if (err) return cb(err);\n\n      let compiler = webpack(config);\n\n      this.logger('adding cache hooks to compiler');\n      compiler.plugin('done', (stats) => {\n        if (stats.hasErrors()) {\n          this.logger('build error(s)...');\n          for (let err of stats.compilation.errors) {\n            this.logger(`... => ${err.stack}`);\n          }\n          caches.set(this.opts, null);\n        } else {\n          caches.set(this.opts, this.generateOutput(stats));\n        }\n      });\n\n      if (this.opts.watch && this.opts.hmr && this.opts.hmrRoot) {\n        this.logger('adding hmr hooks to compiler');\n\n        hmr.register(this.opts);\n\n        compiler.plugin('done', (stats) => {\n          this.logger('emitting done signal to hmr');\n\n          hmr.emitDone(this.opts, stats);\n        });\n\n        compiler.plugin('invalid', () => {\n          this.logger('emitting invalid signal to hmr');\n\n          hmr.emitInvalid(this.opts);\n        });\n      }\n\n      cb(null, compiler);\n    });\n  }\n  compile(cb) {\n    this.getCompiler((err, compiler) => {\n      if (err) return cb(err);\n\n      this.logger('starting compiler');\n      compiler.run((err, stats) => {\n        if (!err && stats.hasErrors()) {\n          err = _.first(stats.compilation.errors);\n        }\n\n        this.logger('compiler completed');\n        this.handleErrAndStats(err, stats, cb);\n      });\n    });\n  }\n  generateOutput(stats) {\n    if (!stats) return null;\n\n    this.logger('generating output object');\n\n    let dependencies = {\n      webpack: require('webpack/package').version,\n      'webpack-build': packageJson.version\n    };\n\n    let statsJson = stats.toJson({\n      modules: false,\n      source: false\n    });\n\n    let assets = _.pluck(stats.compilation.assets, 'existsAt');\n\n    let output = _.transform(stats.compilation.chunks, (result, chunk) => {\n      let obj = {\n        js: [],\n        css: [],\n        files: []\n      };\n\n      chunk.files.forEach((filename) => {\n        filename = path.join(stats.compilation.outputOptions.path, filename);\n        let ext = path.extname(filename);\n        if (ext === '.js') {\n          obj.js.push(filename);\n        } else if (ext === '.css') {\n          obj.css.push(filename);\n        } else {\n          obj.files.push(filename);\n        }\n      });\n\n      result[chunk.name] = obj;\n    }, {});\n\n    let urls = {};\n    if (this.opts.staticRoot && this.opts.staticUrl) {\n      let absPathToRelUrl = (absPath) => {\n        let relPath = absPath.replace(this.opts.staticRoot, '');\n\n        let relUrl = relPath.split(path.sep).join('/');\n        if (_.startsWith(relUrl, '/')) {\n          relUrl = relUrl.slice(1);\n        }\n\n        return this.opts.staticUrl + relUrl;\n      };\n\n      urls = _.transform(output, (result, group, chunkName) => {\n        return result[chunkName] = _.mapValues(group, (paths) => paths.map(absPathToRelUrl));\n      });\n    }\n\n    return {\n      startTime: stats.startTime,\n      endTime: stats.endTime,\n      config: {\n        file: this.opts.config\n      },\n      buildHash: this.opts.buildHash,\n      buildOptions: this.opts,\n      outputOptions: stats.compilation.outputOptions,\n      assets: assets,\n      output: output,\n      urls: urls,\n      stats: statsJson,\n      fileDependencies: stats.compilation.fileDependencies,\n      dependencies: dependencies\n    };\n  }\n  handleErrAndStats(err, stats, cb) {\n    if (err) {\n      return cb(err, stats && this.generateOutput(stats));\n    }\n\n    if (stats.hasErrors()) {\n      err = _.first(stats.compilation.errors);\n    }\n\n    cb(err, this.generateOutput(stats));\n  }\n  getWatcher(cb) {\n    this.logger('fetching watcher');\n\n    if (this.watcher) {\n      return cb(null, this.watcher);\n    }\n\n    this.getCompiler((err, compiler) => {\n      if (err) return cb(err);\n\n      this.logger('creating watcher');\n\n      try {\n        this.watcher = new Watcher(compiler, this.opts);\n      } catch(err) {\n        return cb(err);\n      }\n\n      if (this.opts.config) {\n        this.watcher.onInvalid(() => {\n          this.logger('watcher detected a change');\n        });\n      }\n\n      this.watcher.onFailure((err) => {\n        this.logger('watcher failed', err.stack);\n      });\n\n      cb(null, this.watcher);\n    });\n  }\n  onceWatcherDone(cb) {\n    this.getWatcher((err, watcher) => {\n      if (err) return cb(err);\n\n      watcher.onceDone((err, stats) => {\n        this.logger('watcher provided current build output');\n        this.handleErrAndStats(err, stats, cb);\n      });\n    });\n  }\n  onceDone(cb) {\n    this._onceDone.push(cb);\n\n    this.logger('build requested');\n\n    if (this.opts.watch) {\n      if (this._onceDone.length === 1) {\n        this.onceWatcherDone(this.callDone.bind(this));\n      }\n    } else {\n      this.compile(this.callDone.bind(this));\n    }\n  }\n  callDone(err, stats) {\n    let _onceDone = this._onceDone;\n    this._onceDone = [];\n\n    _onceDone.forEach(cb => cb(err, stats));\n  }\n}\n\nexport default Wrapper;"]}