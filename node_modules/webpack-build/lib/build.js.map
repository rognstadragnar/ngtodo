{"version":3,"sources":["../src/build.js"],"names":[],"mappings":";;;;;;;;kBAAe,IAAI;;;;sBACL,QAAQ;;;;uBACF,WAAW;;;;mBACf,OAAO;;;;sBACJ,UAAU;;;;uBACT,WAAW;;;;uBACX,WAAW;;;;AAE/B,IAAM,KAAK,GAAG,SAAR,KAAK,CAAI,IAAI,EAAE,EAAE,EAAK;AAC1B,MAAI,GAAG,0BAAQ,IAAI,CAAC,CAAC;;AAErB,MAAI,MAAM,GAAG,sBAAI,OAAO,EAAE,IAAI,CAAC,CAAC;AAChC,QAAM,YAAU,IAAI,CAAC,SAAS,gBAAa,CAAC;;AAE5C,MAAI,IAAI,GAAG,SAAP,IAAI,CAAI,GAAG,EAAE,IAAI,EAAK;AACxB,QAAI,GAAG,EAAE,MAAM,CAAC,gCAAgC,EAAE,GAAG,CAAC,CAAC,KAClD,MAAM,CAAC,yBAAyB,CAAC,CAAC;;AAEvC,MAAE,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;GACf,CAAC;;AAEF,QAAM,CAAC,6BAA6B,CAAC,CAAC;AACtC,sBAAO,GAAG,CAAC,IAAI,EAAE,UAAS,GAAG,EAAE,IAAI,EAAE;AACnC,QAAI,GAAG,EAAE;AACP,YAAM,CAAC,yBAAyB,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC;KAChD;;AAED,QAAI,IAAI,EAAE;AACR,YAAM,CAAC,sBAAsB,CAAC,CAAC;AAC/B,UAAI,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;KAClB,MAAM;AACL,YAAM,CAAC,6CAA6C,CAAC,CAAC;KACvD;;AAED,QAAI,CAAC,IAAI,EAAE;AACT,UAAI,qBAAQ,SAAS,EAAE,EAAE;AACvB,cAAM,CAAC,+BAA+B,CAAC,CAAC;AACxC,6BAAQ,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;OAC3B,MAAM;AACL,cAAM,CAAC,+BAA+B,CAAC,CAAC;AACxC,kCAAQ,IAAI,EAAE,IAAI,CAAC,CAAC;OACrB;KACF,MAAM,IAAI,IAAI,CAAC,KAAK,EAAE;AACrB,YAAM,CAAC,gDAAgD,CAAC,CAAC;;AAEzD,UAAI,IAAI,GAAG,SAAP,IAAI,GAAS,aAAa,CAAC;AAC/B,UAAI,qBAAQ,SAAS,EAAE,EAAE;AACvB,6BAAQ,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;OAC3B,MAAM;AACL,kCAAQ,IAAI,EAAE,IAAI,CAAC,CAAC;OACrB;KACF;GACF,CAAC,CAAC;CACJ,CAAC;;qBAEa,KAAK","file":"build.js","sourcesContent":["import fs from 'fs';\nimport _ from 'lodash';\nimport options from './options';\nimport log from './log';\nimport caches from './caches';\nimport workers from './workers';\nimport compile from './compile';\n\nconst build = (opts, cb) => {\n  opts = options(opts);\n\n  let logger = log('build', opts);\n  logger(`build ${opts.buildHash} requested`);\n\n  let emit = (err, data) => {\n    if (err) logger('error encountered during build', err);\n    else logger('serving data from build');\n\n    cb(err, data);\n  };\n\n  logger('requesting data from caches');\n  caches.get(opts, function(err, data) {\n    if (err) {\n      logger('cache produced an error', err.message);\n    }\n\n    if (data) {\n      logger('cached data received');\n      emit(null, data);\n    } else {\n      logger('cache has no matching data or has delegated');\n    }\n\n    if (!data) {\n      if (workers.available()) {\n        logger('Requesting build from workers');\n        workers.build(opts, emit);\n      } else {\n        logger('Requesting build from compile');\n        compile(opts, emit);\n      }\n    } else if (opts.watch) {\n      logger('Ensuring compiler is running in the background');\n\n      let noop = () => {/* no-op */};\n      if (workers.available()) {\n        workers.build(opts, noop);\n      } else {\n        compile(opts, noop);\n      }\n    }\n  });\n};\n\nexport default build;"]}