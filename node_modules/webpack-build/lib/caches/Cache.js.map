{"version":3,"sources":["../../src/caches/Cache.js"],"names":[],"mappings":"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","file":"Cache.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport async from 'async';\nimport mkdirp from 'mkdirp';\nimport log from '../log';\nimport packageJson from '../../package';\n\nclass Cache {\n  constructor(opts) {\n    this.filename = opts.cacheFile;\n    this.logger = log('cache', opts);\n\n    // A flag denoting that another part of the system will serve\n    // the data, rather than this cache\n    this.delegate = false;\n\n    try {\n      let data = fs.readFileSync(this.filename);\n      this.data = JSON.parse(data.toString());\n      this.logger('loaded cache file');\n    } catch(err) {\n      this.logger('cache load error', err.message);\n    }\n\n    if (!this.data) {\n      this.data = {};\n    }\n  }\n  get(cb) {\n    let data = this.data;\n\n    if (!data || !Object.keys(data).length) {\n      this.logger('no data available');\n\n      return cb(null, null);\n    }\n\n    let requiredProps = ['startTime', 'fileDependencies', 'stats', 'config', 'buildHash', 'dependencies', 'assets'];\n\n    for (let prop of requiredProps) {\n      if (!data[prop]) {\n        this.logger(`cached data is missing the ${prop} prop`);\n\n        return cb(null, null);\n      }\n    }\n\n    // Check dependency versions\n    for (let depName of Object.keys(data.dependencies)) {\n      let requiredVersion = data.dependencies[depName];\n\n      let installedVersion;\n      if (depName === packageJson.name) {\n        installedVersion = packageJson.version\n      } else {\n        try {\n          installedVersion = require(`${depName}/package`).version;\n        } catch(err) {\n          this.logger(`cached data references a dependency ${depName} which produced an error during version checks`);\n          return cb(err, null);\n        }\n      }\n\n      if (installedVersion !== requiredVersion) {\n        let required = `${depName}@${requiredVersion}`;\n        let installed = `${depName}@${installedVersion}`;\n        this.logger(`cached data requires a package ${required} but the installed version is ${installed}`);\n\n        return cb(null, null);\n      }\n    }\n\n    // Check the modified times on the config file\n    let configFile = data.config.file;\n    fs.stat(configFile, (err, stats) => {\n      if (err) return cb(err);\n\n      if (+stats.mtime > data.startTime) {\n        return cb(\n          new Error(`Stale config file: ${configFile}. Compile start time: ${data.startTime}. File mtime: ${+stats.mtime}`)\n        );\n      }\n\n      // Check the modified times on the file dependencies\n      async.each(\n        data.fileDependencies,\n        (filename, cb) => {\n          fs.stat(filename, (err, stats) => {\n            if (err) return cb(err);\n\n            if (+stats.mtime > data.startTime) {\n              return cb(\n                new Error(`Stale file dependency: ${filename}. Compile start time: ${data.startTime}. File mtime: ${+stats.mtime}`)\n              );\n            }\n\n            cb(null, true);\n          });\n        },\n        (err) => {\n          if (err) {\n            this.logger(`File dependency error: ${err.message}`);\n            return cb(err);\n          }\n\n          async.each(\n            data.assets,\n            (filename, cb) => {\n              fs.stat(filename, (err) => {\n                if (err) return cb(err);\n\n                cb(null, true);\n              });\n            },\n            (err) => {\n              if (err) {\n                this.logger(`emmitted asset check error: ${err.message}`);\n                return cb(err);\n              }\n\n              this.logger('cached data successfully retrieved');\n              cb(null, data);\n            }\n          );\n        }\n      );\n    });\n  }\n  set(data, delegate) {\n    this.data = data;\n\n    if (delegate) {\n      // Indicate that the we should no longer rely on the cache's store.\n      // This enables the watcher's internal cache to take over the service\n      // of cached output\n      this.delegate = true;\n    }\n\n    this.logger('requesting write to cache file');\n    this.write();\n  }\n  write() {\n    if (this.data && Object.keys(this.data)) {\n      this.logger('updating cache file');\n    } else {\n      this.logger('clearing cache file');\n    }\n\n    let json = JSON.stringify(this.data, null, 2);\n\n    try {\n      mkdirp.sync(path.dirname(this.filename));\n    } catch(err) {\n      throw new Error(`Failed to create path to webpack cache file: ${this.filename}`);\n    }\n\n    try {\n      fs.writeFileSync(this.filename, json);\n    } catch(err) {\n      throw new Error(`Failed to write webpack cache file: ${this.filename}`);\n    }\n  }\n}\n\n\nexport default Cache;"]}