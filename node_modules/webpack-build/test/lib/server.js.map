{"version":3,"sources":["../src/server.js"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport mkdirp from 'mkdirp';\nimport build from '../../lib/index';\nimport Wrapper from '../../lib/wrappers/Wrapper';\nimport wrappers from '../../lib/wrappers';\nimport workers from '../../lib/workers';\nimport caches from '../../lib/caches';\nimport server from '../../lib/server';\nimport request from 'request';\nimport utils from './utils';\n\nlet assert = utils.assert;\nlet TEST_OUTPUT_DIR = utils.TEST_OUTPUT_DIR;\n\n// Ensure we have a clean slate before and after each test\nbeforeEach(() => {\n  wrappers.clear();\n  caches.clear();\n  workers.killAll();\n  utils.cleanTestOutputDir();\n});\nafterEach(() => {\n  wrappers.clear();\n  caches.clear();\n  workers.killAll();\n  utils.cleanTestOutputDir();\n});\n\ndescribe('server', () => {\n  it('should accept POST requests and pass them to `build`', (done) => {\n    let opts = {\n      config: path.join(__dirname, 'test_bundles', 'basic_bundle', 'webpack.config.js')\n    };\n    request('http://127.0.0.1:9009', (err) => {\n      assert.instanceOf(err, Error, 'Sanity check to make sure there isn\\'t another server running');\n\n      server.listen(9009, () => {\n        request.post({\n          url: 'http://127.0.0.1:9009/build',\n          json: true,\n          body: opts\n        }, (err, res, body) => {\n          assert.isNull(err);\n          assert.isObject(body);\n\n          assert.isNull(body.error);\n          assert.isObject(body.data);\n          assert.equal(body.data.config.file, opts.config);\n\n          server.close();\n          done();\n        });\n      });\n    });\n  });\n  it('should accept GET requests and provide some info', (done) => {\n    server.listen(9009, () => {\n      request('http://127.0.0.1:9009', (err, res, body) => {\n        assert.isNull(err);\n        assert.isString(body);\n\n        assert.include(body, '<html>');\n        assert.include(body, 'webpack-build-server');\n\n        server.close();\n        done();\n      });\n    });\n  });\n  it('should handle hmr', (done) => {\n    let configFile = path.join(TEST_OUTPUT_DIR, 'test_server_handles_hmr.js');\n\n    mkdirp.sync(TEST_OUTPUT_DIR);\n\n    fs.writeFileSync(configFile, `\n      module.exports = require('${path.join(__dirname, 'test_bundles', 'basic_bundle', 'webpack.config.js')}');\n    `);\n\n    let opts = {\n      config: configFile,\n      hmr: true,\n      hmrRoot: 'http://example.com',\n      publicPath: '/test'\n    };\n\n    server.listen(9009, () => {\n      request.post({\n        url: 'http://127.0.0.1:9009/build',\n        json: true,\n        body: opts\n      }, (err, res, body) => {\n        assert.isNull(err);\n        assert.isObject(body);\n\n        if (body.error) console.log(JSON.stringify(body.error));\n        assert.isNull(body.error);\n        assert.isObject(body.data);\n        assert.equal(body.data.config.file, opts.config);\n\n        server.close();\n        done();\n      });\n    });\n  });\n  it('should handle hmr with workers', (done) => {\n    let configFile = path.join(TEST_OUTPUT_DIR, 'test_server_handles_hmr_with_workers.js');\n\n    mkdirp.sync(TEST_OUTPUT_DIR);\n\n    fs.writeFileSync(configFile, `\n      module.exports = require('${path.join(__dirname, 'test_bundles', 'basic_bundle', 'webpack.config.js')}');\n    `);\n\n    let opts = {\n      config: configFile,\n      hmr: true,\n      hmrRoot: 'http://example.com',\n      publicPath: '/test'\n    };\n\n    workers.spawn(1);\n\n    server.listen(9009, () => {\n      request.post({\n        url: 'http://127.0.0.1:9009/build',\n        json: true,\n        body: opts\n      }, (err, res, body) => {\n        assert.isNull(err);\n        assert.isObject(body);\n\n        assert.isNull(body.error);\n        assert.isObject(body.data);\n        assert.equal(body.data.config.file, opts.config);\n\n        server.close();\n        done();\n      });\n    });\n  });\n});"]}